<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客戶資料建檔</title>
    <!-- 確保這裡只有這行用於 Tailwind CSS，沒有 <script src="https://cdn.tailwindcss.com"></script> -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <!-- 引入共通 CSS 樣式 -->
    <link rel="stylesheet" href="common_styles.css">
    <!-- 引入共通 JavaScript 函數 -->
    <script src="liff_utils.js"></script>
</head>
<body>

    <h1>客戶資料建檔 V1.23</h1>
    <div id="salesNameDisplay">🔄 載入業務資訊...</div>

    <form id="customerForm">
        <label for="customerCode">客戶編號:</label>
        <input type="number" name="customerCode" id="customerCode" placeholder="請輸入客戶編號" min="10000" max="99999" step="1" required>

        <label for="customerName">客戶名稱:</label>
        <input type="text" name="customerName" id="customerName" placeholder="請輸入客戶名稱" required>

        <label for="sales">業務 (自動填入):</label>
        <input type="text" name="sales" id="sales" required readonly>

        <label for="recordDate">建檔日期:</label>
        <input type="date" name="recordDate" id="recordDate" required>

        <button type="submit" id="submitButton">送出資料</button>
    </form>

    <div id="statusMessage" class="message"></div>

    <script>
        // 請替換成你的 LIFF ID (這必須是您在 LINE Developers Console 中為此 LIFF App 設定的 LIFF ID)
        const liffId = "2007824757-R2rn6zYv"; 
        // 請替換成你的統一GAS專案部署網址 (這必須是您整合後的單一 GAS 專案部署網址)
        const scriptURL = "https://script.google.com/macros/s/AKfycbzCNTksYFIPRKTfFjX4MKoHmNBauBjd9I0ogs5H-TfotL3il-I79gtfJmE2cOlwyKBnXw/exec"; 

        const salesNameDisplay = document.getElementById("salesNameDisplay");
        const salesInput = document.getElementById("sales");
        const recordDateInput = document.getElementById("recordDate");
        const customerForm = document.getElementById("customerForm");
        const customerCodeInput = document.getElementById("customerCode"); 
        const customerNameInput = document.getElementById("customerName"); 
        const submitButton = document.getElementById("submitButton"); 
        const statusMessage = document.getElementById("statusMessage");

        // 頁面初始化函數
        async function initPage() {
            try {
                // 直接呼叫 liff_utils.js 中的 initLiffAndGetProfile
                // 錯誤訊息 "liffId is necessary" 來自這裡的 liff.init()
                await initLiffAndGetProfile(liffId, salesNameDisplay, salesInput);
                // 直接呼叫 liff_utils.js 中的 getTodayDateString
                recordDateInput.value = getTodayDateString();

            } catch (err) {
                // 直接呼叫 liff_utils.js 中的 showStatusMessage
                showStatusMessage(statusMessage, "❌ 頁面初始化失敗，請重新載入。", "error", false);
                console.error("客戶頁面初始化錯誤:", err);
            }
        }

        // 提交成功後的回呼函數
        function onCustomerSubmitSuccess() {
            customerCodeInput.value = ""; 
            customerNameInput.value = ""; 
            customerCodeInput.focus(); 
        }

        // 監聽表單提交事件
        customerForm.addEventListener("submit", (e) => {
            e.preventDefault();
            // 直接呼叫 liff_utils.js 中的 handleFormSubmission
            // 注意：這裡需要傳遞 'submitCustomerData' 作為 action 參數
            handleFormSubmission(
                customerForm, 
                submitButton, 
                statusMessage, 
                scriptURL, 
                "submitCustomerData", // <-- 新增 action 參數
                onCustomerSubmitSuccess
            );
        });

        // 啟動頁面初始化
        initPage();
    </script>
</body>
</html>
