<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>報價回報</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 1em;
    }
    label {
      display: block;
      margin-top: 1em;
    }
    input, textarea, select, button {
      width: 100%;
      padding: 0.5em;
      font-size: 1em;
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>報價資訊回報</h2>
  <div id="userName">載入中...</div>

  <form id="quoteForm">
    <label>客戶名稱
      <select id="clientSelect" name="client" required></select>
    </label>

    <label>報價金額
      <input type="number" name="amount" required>
    </label>

    <label>報價內容
      <textarea name="content" rows="4" required></textarea>
    </label>

    <button type="submit">送出</button>
  </form>

  <script>
    const form = document.getElementById("quoteForm");
    const clientSelect = document.getElementById("clientSelect");

    async function init() {
      await liff.init({ liffId: "2007824757-xMAag5o7" });
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }
      const profile = await liff.getProfile();
      document.getElementById("userName").textContent = `使用者：${profile.displayName}`;

      // 載入客戶選單
      const res = await fetch("https://script.google.com/macros/s/您的GAS-ID/exec");
      const clients = await res.json();
      clients.forEach(client => {
        const option = document.createElement("option");
        option.value = client.id;
        option.textContent = client.name;
        clientSelect.appendChild(option);
      });

      // 儲存 userId
      form.dataset.userId = profile.userId;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = new FormData(form);
      data.append("userId", form.dataset.userId);
      const query = new URLSearchParams(data).toString();
      const response = await fetch("https://script.google.com/macros/s/AKfycbztVuE7W79IbZBqfzJdhEop5s_plV5um0D_YZb15vJkyhfgltMND_7QqXOAlpPHTFsExw/exec", {
        method: "POST",
        body: query,
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
      });
      const result = await response.text();
      alert(result === "OK" ? "已送出" : "送出失敗");
    });

    init();
  </script>
</body>
</html>
