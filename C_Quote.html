<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±åƒ¹ç¶­è­·é é¢</title>
    <!-- å¼•å…¥é ç·¨è­¯çš„ Tailwind CSS æª”æ¡ˆ -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- å¼•å…¥å…±é€š CSS æ¨£å¼ -->
    <link rel="stylesheet" href="common_styles.css">
    <!-- å¼•å…¥è¨­å®šæª” (å¿…é ˆåœ¨ liff_utils.js ä¹‹å‰) -->
    <script src="config.js"></script>
    <!-- å¼•å…¥å…±é€š JavaScript å‡½æ•¸ -->
    <script src="liff_utils.js"></script>
</head>
<body>

    <h1>å ±åƒ¹ç¶­è­· V1.0</h1>
    <div id="salesNameDisplay">ğŸ”„ è¼‰å…¥æ¥­å‹™è³‡è¨Š...</div>

    <form id="quoteForm">
        <label for="customer">å®¢æˆ¶:</label>
        <select name="customer" id="customer" required class="w-full p-2 border rounded-md mb-4">
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>

        <label for="product">ç”¢å“:</label>
        <select name="product" id="product" required class="w-full p-2 border rounded-md mb-4">
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>

        <label for="quoteDate">å ±åƒ¹æ—¥æœŸ:</label>
        <input type="date" name="quoteDate" id="quoteDate" required class="w-full p-2 border rounded-md mb-4">

        <label for="sales">æ¥­å‹™ (è‡ªå‹•å¡«å…¥):</label>
        <input type="text" name="sales" id="sales" required readonly class="w-full p-2 border rounded-md mb-4 bg-gray-100 cursor-not-allowed">

        <label for="description">èªªæ˜:</label>
        <textarea name="description" id="description" placeholder="è«‹è¼¸å…¥å ±åƒ¹èªªæ˜ (å¯é¸)" rows="4" class="w-full p-2 border rounded-md mb-4"></textarea>

        <button type="submit" id="submitButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-md transition duration-300 ease-in-out">é€å‡ºè³‡æ–™</button>
    </form>

    <div id="statusMessage" class="message"></div>

    <script>
        // è«‹æ›¿æ›æˆä½ çš„ LIFF ID (æ­¤é é¢å°ˆå±¬)
        const liffId = "2007824757-xMAag5o7"; 
        // GAS éƒ¨ç½²ç¶²å€å°‡å¾ config.js ç²å–
        const gasDataFetchURL = APP_CONFIG.gasScriptURL; // doGet è«‹æ±‚çš„ GAS éƒ¨ç½²ç¶²å€ï¼Œä½¿ç”¨ APP_CONFIG

        const salesNameDisplay = document.getElementById("salesNameDisplay");
        const salesInput = document.getElementById("sales");
        const quoteDateInput = document.getElementById("quoteDate");
        const customerSelect = document.getElementById("customer");
        const productSelect = document.getElementById("product");
        const quoteForm = document.getElementById("quoteForm");
        const submitButton = document.getElementById("submitButton");
        const statusMessage = document.getElementById("statusMessage");

        let currentSalesDisplayName = ""; // ç”¨æ–¼å„²å­˜ç•¶å‰æ¥­å‹™çš„ LINE é¡¯ç¤ºåç¨±ï¼Œä»¥ä¾¿ç¯©é¸å®¢æˆ¶

        /**
         * å¾ GAS ç²å–ä¸‹æ‹‰é¸å–®è³‡æ–™ã€‚
         */
        async function fetchDropdownData() {
            try {
                // ç²å–å®¢æˆ¶è³‡æ–™ (æ ¹æ“šç•¶å‰æ¥­å‹™ç¯©é¸)
                const customerResponse = await fetch(`${gasDataFetchURL}?action=getCustomersForQuote&sales=${encodeURIComponent(currentSalesDisplayName)}`);
                const customerData = await customerResponse.json();
                
                customerSelect.innerHTML = '<option value="">è«‹é¸æ“‡å®¢æˆ¶</option>'; // æ¸…ç©ºä¸¦æ·»åŠ é è¨­é¸é …
                if (customerData.customers && customerData.customers.length > 0) {
                    customerData.customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer;
                        option.textContent = customer;
                        customerSelect.appendChild(option);
                    });
                } else {
                    customerSelect.innerHTML = '<option value="">ç„¡å¯ç”¨å®¢æˆ¶è³‡æ–™</option>';
                }

                // ç²å–ç”¢å“è³‡æ–™
                const productResponse = await fetch(`${gasDataFetchURL}?action=getProductsForQuote`);
                const productData = await productResponse.json();
                
                productSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç”¢å“</option>'; // æ¸…ç©ºä¸¦æ·»åŠ é è¨­é¸é …
                if (productData.products && productData.products.length > 0) {
                    productData.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product;
                        option.textContent = product;
                        productSelect.appendChild(option);
                    });
                } else {
                    productSelect.innerHTML = '<option value="">ç„¡å¯ç”¨ç”¢å“è³‡æ–™</option>';
                }

            } catch (error) {
                console.error("ç²å–ä¸‹æ‹‰é¸å–®è³‡æ–™å¤±æ•—:", error);
                showStatusMessage(statusMessage, "âŒ ç„¡æ³•è¼‰å…¥ä¸‹æ‹‰é¸å–®è³‡æ–™ã€‚", "error", false);
                customerSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                productSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
            }
        }

        // é é¢åˆå§‹åŒ–å‡½æ•¸
        async function initPage() {
            try {
                // initLiffAndGetProfile æœƒåœ¨å…§éƒ¨æŸ¥è©¢å¯¦éš›åå­—ä¸¦è¨­å®šé¡¯ç¤ºï¼ŒåŒæ™‚å°‡ LINE åç¨±å¡«å…¥ input
                const profile = await initLiffAndGetProfile(liffId, salesNameDisplay, salesInput);
                currentSalesDisplayName = profile.displayName; // å„²å­˜ LINE é¡¯ç¤ºåç¨±ï¼Œç”¨æ–¼ç¯©é¸å®¢æˆ¶
                
                quoteDateInput.value = getTodayDateString();
                
                await fetchDropdownData(); // ç²å–ä¸‹æ‹‰é¸å–®è³‡æ–™

            } catch (err) {
                showStatusMessage(statusMessage, "âŒ é é¢åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥ã€‚", "error", false);
                console.error("å ±åƒ¹é é¢åˆå§‹åŒ–éŒ¯èª¤:", err);
            }
        }

        // æäº¤æˆåŠŸå¾Œçš„å›å‘¼å‡½æ•¸
        function onQuoteSubmitSuccess() {
            quoteForm.reset(); // æ¸…ç©ºæ‰€æœ‰æ¬„ä½
            quoteDateInput.value = getTodayDateString(); // é‡æ–°è¨­å®šæ—¥æœŸ
            customerSelect.value = ""; 
            productSelect.value = "";
            customerSelect.focus(); // å°‡ç„¦é»ç§»å›å®¢æˆ¶ä¸‹æ‹‰é¸å–®
        }

        // ç›£è½è¡¨å–®æäº¤äº‹ä»¶
        quoteForm.addEventListener("submit", (e) => {
            e.preventDefault();
            handleFormSubmission(
                quoteForm, 
                submitButton, 
                statusMessage, 
                APP_CONFIG.gasScriptURL, // ä½¿ç”¨ APP_CONFIG.gasScriptURL
                "submitQuoteData", 
                onQuoteSubmitSuccess
            );
        });

        // å•Ÿå‹•é é¢åˆå§‹åŒ–
        initPage();
    </script>
</body>
</html>
