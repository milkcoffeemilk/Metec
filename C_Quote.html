<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±åƒ¹ç¶­è­·é é¢</title>
    <!-- å¼•å…¥é ç·¨è­¯çš„ Tailwind CSS æª”æ¡ˆ -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- å¼•å…¥å…±é€š CSS æ¨£å¼ -->
    <link rel="stylesheet" href="common_styles.css">
    <!-- å¼•å…¥å…±é€š JavaScript å‡½æ•¸ -->
    <script src="liff_utils.js"></script>
</head>
<body>

    <h1>å ±åƒ¹ç¶­è­· V1.05</h1>
    <div id="salesNameDisplay">ğŸ”„ è¼‰å…¥æ¥­å‹™è³‡è¨Š...</div>

    <form id="quoteForm">
        <label for="customer">å®¢æˆ¶:</label>
        <select name="customer" id="customer" required class="w-full p-2 border rounded-md mb-4">
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>

        <label for="product">ç”¢å“:</label>
        <select name="product" id="product" required class="w-full p-2 border rounded-md mb-4">
            <option value="">è¼‰å…¥ä¸­...</option>
        </select>

        <label for="quoteDate">å ±åƒ¹æ—¥æœŸ:</label>
        <input type="date" name="quoteDate" id="quoteDate" required class="w-full p-2 border rounded-md mb-4">

        <label for="sales">æ¥­å‹™ (è‡ªå‹•å¡«å…¥):</label>
        <input type="text" name="sales" id="sales" required readonly class="w-full p-2 border rounded-md mb-4 bg-gray-100 cursor-not-allowed">

        <label for="description">èªªæ˜:</label>
        <textarea name="description" id="description" placeholder="è«‹è¼¸å…¥å ±åƒ¹èªªæ˜ (å¯é¸)" rows="4" class="w-full p-2 border rounded-md mb-4"></textarea>

        <button type="submit" id="submitButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-md transition duration-300 ease-in-out">é€å‡ºè³‡æ–™</button>
    </form>

    <div id="statusMessage" class="message"></div>

    <script>
        // ã€ä¿®æ­£é»ã€‘å°‡æ‰€æœ‰ DOM å…ƒç´ è®Šæ•¸å®£å‘Šç§»åˆ°æœ€ä¸Šæ–¹
        const salesNameDisplay = document.getElementById("salesNameDisplay");
        const salesInput = document.getElementById("sales");
        const quoteDateInput = document.getElementById("quoteDate");
        const customerSelect = document.getElementById("customer");
        const productSelect = document.getElementById("product");
        const quoteForm = document.getElementById("quoteForm");
        const submitButton = document.getElementById("submitButton");
        const statusMessage = document.getElementById("statusMessage");

        // è«‹æ›¿æ›æˆä½ çš„ LIFF ID (èˆ‡å…¶ä»–é é¢å…±ç”¨æˆ–ç¨ç«‹)
        const liffId = "2007824757-xMAag5o7"; 
        // è«‹æ›¿æ›æˆä½ çš„çµ±ä¸€GASå°ˆæ¡ˆéƒ¨ç½²ç¶²å€ (doPost å’Œ doGet éƒ½ä½¿ç”¨é€™å€‹ URL)
        const scriptURL = "https://script.google.com/macros/s/AKfycbzCNTksYFIPRKTfFjX4MKoHmNBauBjd9I0ogs5H-TfotL3il-I79gtfJmE2cOlwyKBnXw/exec"; 
        const gasDataFetchURL = scriptURL; // doGet è«‹æ±‚çš„ GAS éƒ¨ç½²ç¶²å€ï¼Œé€šå¸¸èˆ‡ scriptURL ç›¸åŒ

        let currentSalesDisplayName = ""; // ç”¨æ–¼å„²å­˜ç•¶å‰æ¥­å‹™çš„ LINE é¡¯ç¤ºåç¨±ï¼Œä»¥ä¾¿ç¯©é¸å®¢æˆ¶

        /**
         * å¾ GAS ç²å–ä¸‹æ‹‰é¸å–®è³‡æ–™ã€‚
         */
        async function fetchDropdownData() {
            try {
                // ç²å–å®¢æˆ¶è³‡æ–™ (æ ¹æ“šç•¶å‰æ¥­å‹™ç¯©é¸)
                const customerResponse = await fetch(`${gasDataFetchURL}?action=getCustomersForQuote&sales=${encodeURIComponent(currentSalesDisplayName)}`);
                const customerData = await customerResponse.json();
                
                customerSelect.innerHTML = '<option value="">è«‹é¸æ“‡å®¢æˆ¶</option>'; // æ¸…ç©ºä¸¦æ·»åŠ é è¨­é¸é …
                if (customerData.customers && customerData.customers.length > 0) {
                    customerData.customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer;
                        option.textContent = customer;
                        customerSelect.appendChild(option);
                    });
                } else {
                    customerSelect.innerHTML = '<option value="">ç„¡å¯ç”¨å®¢æˆ¶è³‡æ–™</option>';
                }

                // ç²å–ç”¢å“è³‡æ–™
                const productResponse = await fetch(`${gasDataFetchURL}?action=getProductsForQuote`);
                const productData = await productResponse.json();
                
                productSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç”¢å“</option>'; // æ¸…ç©ºä¸¦æ·»åŠ é è¨­é¸é …
                if (productData.products && productData.products.length > 0) {
                    productData.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product;
                        option.textContent = product;
                        productSelect.appendChild(option);
                    });
                } else {
                    productSelect.innerHTML = '<option value="">ç„¡å¯ç”¨ç”¢å“è³‡æ–™</option>';
                }

            } catch (error) {
                console.error("ç²å–ä¸‹æ‹‰é¸å–®è³‡æ–™å¤±æ•—:", error);
                // ä½¿ç”¨å…±é€šçš„ showStatusMessage å‡½æ•¸
                showStatusMessage(statusMessage, "âŒ ç„¡æ³•è¼‰å…¥ä¸‹æ‹‰é¸å–®è³‡æ–™ã€‚", "error", false);
                customerSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                productSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
            }
        }

        // é é¢åˆå§‹åŒ–å‡½æ•¸
        async function initPage() {
            try {
                // åˆå§‹åŒ– LIFF ä¸¦ç²å–ä½¿ç”¨è€…è³‡æ–™
                const profile = await initLiffAndGetProfile(liffId, salesNameDisplay, salesInput);
                currentSalesDisplayName = profile.displayName; // å„²å­˜æ¥­å‹™åç¨±
                
                // è‡ªå‹•å¡«å…¥ä»Šå¤©çš„æ—¥æœŸ
                recordDateInput.value = getTodayDateString(); // ç¾åœ¨ recordDateInput æ‡‰è©²å·²ç¶“å®šç¾©äº†
                
                // ç²å–ä¸‹æ‹‰é¸å–®è³‡æ–™
                await fetchDropdownData(); 

            } catch (err) {
                // ä½¿ç”¨å…±é€šçš„ showStatusMessage å‡½æ•¸
                showStatusMessage(statusMessage, "âŒ é é¢åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥ã€‚", "error", false);
                console.error("å ±åƒ¹é é¢åˆå§‹åŒ–éŒ¯èª¤:", err);
            }
        }

        // æäº¤æˆåŠŸå¾Œçš„å›å‘¼å‡½æ•¸
        function onQuoteSubmitSuccess() {
            quoteForm.reset(); // æ¸…ç©ºæ‰€æœ‰æ¬„ä½
            recordDateInput.value = getTodayDateString(); // é‡æ–°è¨­å®šæ—¥æœŸ
            // ä¸‹æ‹‰é¸å–®æœƒè‡ªå‹•å›åˆ°é è¨­é¸é …ï¼Œä½†ç‚ºäº†ç¢ºä¿ä¸€è‡´æ€§ï¼Œå¯ä»¥æ˜ç¢ºè¨­å®š
            customerSelect.value = ""; 
            productSelect.value = "";
            customerSelect.focus(); // å°‡ç„¦é»ç§»å›å®¢æˆ¶ä¸‹æ‹‰é¸å–®
        }

        // ç›£è½è¡¨å–®æäº¤äº‹ä»¶
        quoteForm.addEventListener("submit", (e) => {
            e.preventDefault();
            handleFormSubmission(
                quoteForm, 
                submitButton, 
                statusMessage, 
                scriptURL, 
                "submitQuoteData", // <-- æ–°å¢ action åƒæ•¸
                onQuoteSubmitSuccess
            );
        });

        // å•Ÿå‹•é é¢åˆå§‹åŒ–
        initPage();
    </script>
</body>
</html>
