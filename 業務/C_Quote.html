<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>報價維護頁面</title>
    <!-- 引入預編譯的 Tailwind CSS 檔案 -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- 引入共通 CSS 樣式 -->
    <link rel="stylesheet" href="common_styles.css">
    <!-- 引入設定檔 (必須在 liff_utils.js 之前) -->
    <script src="config.js"></script>
    <!-- 引入共通 JavaScript 函數 -->
    <script src="liff_utils.js"></script>
</head>
<body>

    <h1>報價維護 V1.02</h1>
    <div id="salesNameDisplay">🔄 載入業務資訊...</div>

    <form id="quoteForm">
        <div class="flex items-end mb-4">
            <div class="flex-grow">
                <label for="customer">客戶:</label>
                <select name="customer" id="customer" required class="w-full p-2 border rounded-md">
                    <option value="">載入中...</option>
                </select>
            </div>
            <!-- 【新增】新增客戶按鈕 -->
            <button type="button" id="addCustomerButton" class="hidden ml-2 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 ease-in-out">新增客戶</button>
        </div>

        <label for="product">產品:</label>
        <select name="product" id="product" required class="w-full p-2 border rounded-md mb-4">
            <option value="">載入中...</option>
        </select>

        <label for="unitPrice">單價:</label>
        <input type="number" name="unitPrice" id="unitPrice" placeholder="請輸入單價" min="0" step="0.01" class="w-full p-2 border rounded-md mb-4" required>

        <label for="quoteDate">報價日期:</label>
        <input type="date" name="quoteDate" id="quoteDate" required class="w-full p-2 border rounded-md mb-4">

        <label for="sales">業務 (自動填入):</label>
        <input type="text" name="sales" id="sales" required readonly class="w-full p-2 border rounded-md mb-4 bg-gray-100 cursor-not-allowed">

        <label for="description">說明:</label>
        <textarea name="description" id="description" placeholder="請輸入報價說明 (可選)" rows="4" class="w-full p-2 border rounded-md mb-4"></textarea>

        <button type="submit" id="submitButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-md transition duration-300 ease-in-out">送出資料</button>
    </form>

    <div id="statusMessage" class="message"></div>

    <script>
        // 請替換成你的 LIFF ID (此頁面專屬)
        const liffId = "2007824757-xMAag5o7"; 
        // GAS 部署網址將從 config.js 獲取
        const gasDataFetchURL = APP_CONFIG.gasScriptURL; // doGet 請求的 GAS 部署網址，使用 APP_CONFIG

        // 【重要】請替換為您的 A_Cust.html 的公開可訪問 URL
        const A_Cust_HTML_URL = "https://liff.line.me/2007824757-R2rn6zYv"; 

        const salesNameDisplay = document.getElementById("salesNameDisplay");
        const salesInput = document.getElementById("sales");
        const quoteDateInput = document.getElementById("quoteDate");
        const customerSelect = document.getElementById("customer");
        const productSelect = document.getElementById("product");
        const unitPriceInput = document.getElementById("unitPrice");
        const quoteForm = document.getElementById("quoteForm");
        const submitButton = document.getElementById("submitButton");
        const statusMessage = document.getElementById("statusMessage");
        const addCustomerButton = document.getElementById("addCustomerButton"); // 【新增】獲取新增客戶按鈕

        let currentSalesDisplayName = ""; // 用於儲存當前業務的 LINE 顯示名稱，以便篩選客戶

        /**
         * 從 GAS 獲取下拉選單資料。
         */
        async function fetchDropdownData() {
            try {
                // 獲取客戶資料 (根據當前業務篩選)
                const customerResponse = await fetch(`${gasDataFetchURL}?action=getCustomersForQuote&sales=${encodeURIComponent(currentSalesDisplayName)}`);
                const customerData = await customerResponse.json();
                
                customerSelect.innerHTML = ''; // 清空所有選項
                if (customerData.customers && customerData.customers.length > 0) {
                    customerSelect.innerHTML = '<option value="">請選擇客戶</option>'; // 添加預設選項
                    customerData.customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer;
                        option.textContent = customer;
                        customerSelect.appendChild(option);
                    });
                    addCustomerButton.classList.add('hidden'); // 有客戶資料時隱藏按鈕
                } else {
                    customerSelect.innerHTML = '<option value="">無可用客戶資料，請新增</option>'; // 顯示提示
                    addCustomerButton.classList.remove('hidden'); // 無客戶資料時顯示按鈕
                }

                // 獲取產品資料 (傳遞 sales 參數用於篩選)
                const productResponse = await fetch(`${gasDataFetchURL}?action=getProductsForQuote&sales=${encodeURIComponent(currentSalesDisplayName)}`);
                const productData = await productResponse.json();
                
                productSelect.innerHTML = '<option value="">請選擇產品</option>'; // 清空並添加預設選項
                if (productData.products && productData.products.length > 0) {
                    productData.products.forEach(product => { 
                        const option = document.createElement('option');
                        option.value = product;
                        option.textContent = product;
                        productSelect.appendChild(option);
                    });
                } else {
                    productSelect.innerHTML = '<option value="">無可用產品資料</option>';
                }

            } catch (error) {
                console.error("獲取下拉選單資料失敗:", error);
                showStatusMessage(statusMessage, "❌ 無法載入下拉選單資料。", "error", false);
                customerSelect.innerHTML = '<option value="">載入失敗</option>';
                productSelect.innerHTML = '<option value="">載入失敗</option>';
                addCustomerButton.classList.remove('hidden'); // 載入失敗時也顯示按鈕
            }
        }

        // 頁面初始化函數
        async function initPage() {
            try {
                // initLiffAndGetProfile 會在內部查詢實際名字並設定顯示，同時將 LINE 名稱填入 input
                const profile = await initLiffAndGetProfile(liffId, salesNameDisplay, salesInput);
                currentSalesDisplayName = profile.displayName; // 儲存 LINE 顯示名稱，用於篩選客戶和產品
                
                quoteDateInput.value = getTodayDateString();
                
                await fetchDropdownData(); // 獲取下拉選單資料

            } catch (err) {
                showStatusMessage(statusMessage, "❌ 頁面初始化失敗，請重新載入。", "error", false);
                console.error("報價頁面初始化錯誤:", err);
            }
        }

        // 提交成功後的回呼函數
        function onQuoteSubmitSuccess() {
            quoteForm.reset(); // 清空所有欄位
            quoteDateInput.value = getTodayDateString(); // 重新設定日期
            customerSelect.value = ""; 
            productSelect.value = "";
            unitPriceInput.value = ""; // 清空單價
            customerSelect.focus(); // 將焦點移回客戶下拉選單
            // 重新載入下拉選單，以反映可能新增的客戶
            fetchDropdownData(); 
        }

        // 監聽表單提交事件
        quoteForm.addEventListener("submit", (e) => {
            e.preventDefault();
            handleFormSubmission(
                quoteForm, 
                submitButton, 
                statusMessage, 
                APP_CONFIG.gasScriptURL, // 使用 APP_CONFIG.gasScriptURL
                "submitQuoteData", 
                onQuoteSubmitSuccess
            );
        });

        // 【新增】監聽新增客戶按鈕點擊事件
        addCustomerButton.addEventListener('click', () => {
            if (liff.isLoggedIn() && A_Cust_HTML_URL) {
                liff.openWindow({
                    url: A_Cust_HTML_URL,
                    external: false // 在 LINE 應用程式內開啟新視窗
                });
            } else {
                showStatusMessage(statusMessage, "❌ 無法開啟新增客戶頁面，請確認 LIFF 登入狀態或網址。", "error", false);
            }
        });

        // 啟動頁面初始化
        initPage();
    </script>
</body>
</html>
